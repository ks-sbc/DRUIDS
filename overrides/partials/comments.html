{% if page.meta.comments %}
  <h2 id="__comments">{{ lang.t("meta.comments") }}</h2>
  <div id="__comments_container" data-md-component="comments">
    <div class="giscus-loading">Loading comments...</div>
  </div>

  <script>
    // Giscus configuration
    const giscusAttributes = {
      "src": "https://giscus.app/client.js",
      "data-repo": "{{ config.extra.comments.giscus.repo }}",
      "data-repo-id": "{{ config.extra.comments.giscus['repo-id'] }}",
      "data-category": "{{ config.extra.comments.giscus.category }}",
      "data-category-id": "{{ config.extra.comments.giscus['category-id'] }}",
      "data-mapping": "{{ config.extra.comments.giscus.mapping }}",
      "data-strict": "{{ config.extra.comments.giscus.strict }}",
      "data-reactions-enabled": "{{ config.extra.comments.giscus['reactions-enabled'] }}",
      "data-emit-metadata": "{{ config.extra.comments.giscus['emit-metadata'] }}",
      "data-input-position": "{{ config.extra.comments.giscus['input-position'] }}",
      "data-theme": "{{ config.extra.comments.giscus.theme }}",
      "data-lang": "{{ config.extra.comments.giscus.lang }}",
      "data-loading": "{{ config.extra.comments.giscus.loading }}",
      "crossorigin": "anonymous",
      "async": ""
    };

    // Apply palette on next tick
    requestAnimationFrame(() => {
      const palette = __md_get("__palette");
      if (palette && typeof palette.color === "object") {
        const theme = palette.color.scheme === "slate" ? "dark" : "light";
        giscusAttributes["data-theme"] = theme;
      }

      // Create and append Giscus script
      const giscusScript = document.createElement("script");
      Object.entries(giscusAttributes).forEach(([key, value]) => {
        giscusScript.setAttribute(key, value);
      });

      // Replace loading message with script
      const container = document.getElementById("__comments_container");
      container.innerHTML = "";
      container.appendChild(giscusScript);
    });

    // Listen for palette changes
    document.addEventListener("DOMContentLoaded", () => {
      const ref = document.querySelector("[data-md-component=palette]");
      if (ref) {
        ref.addEventListener("change", () => {
          const palette = __md_get("__palette");
          if (palette && typeof palette.color === "object") {
            const theme = palette.color.scheme === "slate" ? "dark" : "light";
            
            // Send theme change message to Giscus
            const iframe = document.querySelector("iframe.giscus-frame");
            if (iframe) {
              iframe.contentWindow.postMessage(
                { giscus: { setConfig: { theme } } },
                "https://giscus.app"
              );
            }
          }
        });
      }
    });
  </script>
{% endif %}